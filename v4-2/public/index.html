<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Brightly Pk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <style>
        /* å…¬å‘Šæ¨¡æ€æ¡†æ ·å¼ */
        #announcementModal .modal-content {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        #announcementContent h4 {
            color: #4299e1;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        
        #announcementContent ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        #announcementContent li {
            margin-bottom: 5px;
        }
        
        #announcementContent .highlight {
            background-color: #fffacd;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
            margin: 10px 0;
        }
        
        .announcement-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .announcement-item:last-child {
            border-bottom: none;
        }
        
        /* æ¨¡æ€æ¡†åŸºæœ¬æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #718096;
        }
        
        .close:hover {
            color: #2d3748;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #3182ce;
        }
        
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-secondary:hover {
            background-color: #cbd5e0;
        }
        
        /* å¯¼èˆªæ æŒ‰é’®æ ·å¼ */
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            color: #718096;
            transition: all 0.3s;
            flex: 1;
            font-size: 12px;
        }
        
        .nav-btn.active {
            color: #4299e1;
        }
        
        .nav-btn .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.success {
            background-color: #48bb78;
        }
        
        .toast.error {
            background-color: #f56565;
        }
        
        .toast.info {
            background-color: #4299e1;
        }
    </style>
</head>

<body>
    <!-- å…¬å‘Šæ¨¡æ€æ¡† -->
    <div id="announcementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h3>
                <span class="close" onclick="closeAnnouncementModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="announcementContent" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                    <!-- å…¬å‘Šå†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    <p>æ­£åœ¨åŠ è½½å…¬å‘Š...</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="dontShowAgain"> ä¸å†æ˜¾ç¤ºæ­¤å…¬å‘Š
                </label>
                <div>
                    <button onclick="closeAnnouncementModal()" class="btn-primary">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤ºå®¹å™¨ -->
    <div id="toastContainer"></div>
    
    <script src="axios.min.js"></script>
    <script src="js/friends-chat.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/config-func.js"></script>
    <script src="js/pk.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/leaderboard.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/qbank.js"></script>
    <script src="js/world-chat.js"></script>
    

    <div id="loading-indicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; font-size: 16px; color: #666;">
        <div class="spinner" style="font-size: 32px; margin-bottom: 16px;"></div>
        <div class="loading-text">è€å¿ƒç­‰ç­‰æˆ‘ä»¬ï¼Œé¦–æ¬¡åŠ è½½æ¯”è¾ƒæ…¢å“¦~ Ëµ^â€¢ğ–¥¦â€¢^Ëµ </div>
        <div class="loading-timer" style="font-size: 14px; color: #999;">å·²ç­‰å¾…ï¼š<span id="timer">0</span> ç§’</div>
    </div>
    <!-- æ³¨å†ŒåŠç™»å½•æ¨¡å— -->
    <div class="container">
        <!-- æ³¨å†Œæ¨¡å— -->
        <div id="registerModule" class="module">
            <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-16ä½ï¼Œå”¯ä¸€ï¼‰" required>
            <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆ6-20ä½ï¼‰" required>
            <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±" required>
            <div class="btn-group">
                <button onclick="registerUser()" id="regBtn">æ³¨å†Œ</button>
            </div>
            <p style="text-align: center; margin-top: 15px;">å·²æœ‰è´¦å·ï¼Ÿ<a href="javascript:showModule('loginModule')">ç«‹å³ç™»å½•</a></p>
            <div id="regMsg" class="msg"></div>
        </div>

        <!-- ç™»å½•æ¨¡å— -->
        <div id="loginModule" class="module" style="display: none;">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
            <div class="btn-group">
                <button onclick="loginUser()" id="loginBtn">ç™»å½•</button>
            </div>
            <p style="text-align: center; margin-top: 15px;">æ²¡æœ‰è´¦å·ï¼Ÿ<a href="javascript:showModule('registerModule')">ç«‹å³æ³¨å†Œ</a></p>
            <div id="loginMsg" class="msg"></div>
        </div>

        <!-- æ¸¸æˆä¸»æ¨¡å—ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
        <div id="gameModule" class="module" style="display: none;">
            <h2>Brightly Pk é«˜ä¸­æ•°å­¦ç‰ˆ</h2>

            <!-- é¡¶éƒ¨æŒ‰é’®å®¹å™¨  -->
            <div class="top-buttons">
                <button onclick="showAnnouncementModal()" class="btn-secondary" style="background:#edf2f7; color:#4a5568; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.3s; font-size:14px; display: inline-flex; align-items: center; gap: 4px;">
                    ğŸ“¢ å…¬å‘Š
                </button>
                <button onclick="logout()" class="btn-secondary" style="background:#edf2f7; color:#4a5568; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.3s; font-size:14px; display: inline-flex; align-items: center; gap: 4px;">
                    ğŸšª é€€å‡º
                </button>
            </div>
            <div id="userInfo"></div>

            <!-- å¯¹æˆ˜æ¨¡å— -->
            <div id="gameSection-match" class="game-section active">
                <!-- åŒ¹é…æ¨¡å— -->
                <div id="matchModule">
                    <h3>å¯¹æˆ˜åŒ¹é…</h3>
                    <div class="difficulty-selector">
                        <label style="margin-right: 15px;">é€‰æ‹©éš¾åº¦ï¼š</label>
                        <button onclick="selectDifficulty('easy')" id="easyBtn" class="difficulty-btn">ç®€å•</button>
                        <button onclick="selectDifficulty('medium')" id="mediumBtn" class="difficulty-btn">ä¸­ç­‰</button>
                        <button onclick="selectDifficulty('hard')" id="hardBtn" class="difficulty-btn">å›°éš¾</button>
                    </div>
                    <div class="btn-group">
                        <button onclick="joinMatch()" id="joinMatchBtn" disabled>å‘èµ·åŒ¹é…</button>
                        <button onclick="cancelMatch()" id="cancelMatchBtn" style="display: none; background: #e53e3e;">å–æ¶ˆåŒ¹é…</button>
                    </div>
                    <div id="matchStatus" class="msg info"></div>
                </div>

                <!-- å¯¹æˆ˜æ¨¡å—ï¼ˆåŒ¹é…æˆåŠŸåæ˜¾ç¤ºï¼‰ -->
                <div id="battleModule" style="display: none;">
                    <div class="battle-info">
                        <h3>å¯¹æˆ˜ä¸­</h3>
                        <div class="opponent-info">
                            <div class="opponent-avatar">?</div>
                            <div>å¯¹æ‰‹ï¼š<span id="opponentName"></span></div>
                        </div>
                        <div class="time-indicator" id="answerTime"></div>
                    </div>

                    <!-- æ–°å¢ï¼šå®‰å…¨é€€å‡ºæŒ‰é’®åŒºåŸŸ -->
                    <div id="battleControls" style="margin: 10px 0; text-align: center;">
                        <button id="safeExitBtn" class="btn-secondary" style="display:none; margin-left:10px;">
                            ğŸ›¡ï¸ å®‰å…¨é€€å‡º
                        </button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>

                    <div id="countdown"></div>

                    <div class="question-card">
                        <div class="question-title" id="questionArea"></div>
                        <div id="optionArea"></div>
                    </div>

                    <div id="battleProgress">
                        <p>ä½ çš„å¾—åˆ†ï¼š<span id="myScore" style="color: #4299e1; font-weight: bold;">0</span></p>
                        <p>å¯¹æ‰‹å¾—åˆ†ï¼š<span id="opponentScore" style="color: #e53e3e; font-weight: bold;">0</span></p>
                    </div>
                </div>

                <!-- å¯¹æˆ˜ç»“æœæ¨¡å— -->
                <div id="resultModule" style="display: none;">
                    <h3>å¯¹æˆ˜ç»“æœ</h3>
                    <div id="resultDetail"></div>
                    <div class="btn-group">
                        <button onclick="backToMatch()">è¿”å›å¯¹æˆ˜</button>
                        <button onclick="getBattleDetail()">æŸ¥çœ‹å¯¹æˆ˜è¯¦æƒ…</button>
                        <button onclick="addOpponentAsFriend()" id="addFriendBtn" style="background: #48bb78;">åŠ ä¸ºå¥½å‹</button>
                    </div>
                </div>
            </div>
            <!-- æ’è¡Œæ¦œæ¨¡å— -->
            <div id="gameSection-leaderboard" class="game-section">
                <div class="section-header">
                    <h2>æ’è¡Œæ¦œ</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <!-- <span>åˆ·æ–°å€’è®¡æ—¶: <span id="refreshCountdown">5</span>ç§’</span> -->
                        <button onclick=" refreshLeaderboard(); showToast('æ’è¡Œæ¦œå·²åˆ·æ–°', 'success')" class="btn-primary">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>

                <div class="leaderboard-container">
                    <!-- æ’è¡Œæ¦œæ ‡ç­¾é¡µ -->
                    <div class="leaderboard-tabs">
                        <button onclick="showLeaderboardTab('score')" class="leaderboard-tab active" id="tabScore">ç§¯åˆ†æ¦œ</button>
                        <button onclick="showLeaderboardTab('winRate')" class="leaderboard-tab" id="tabWinRate">èƒœç‡æ¦œ</button>
                        <button onclick="showLeaderboardTab('streak')" class="leaderboard-tab" id="tabStreak">è¿èƒœæ¦œ</button>
                        <button onclick="showLeaderboardTab('friends')" class="leaderboard-tab" id="tabFriends">å¥½å‹æ¦œ</button>
                        <!-- <button onclick="showLeaderboardTab('difficulty')" class="leaderboard-tab" id="tabDifficulty">éš¾åº¦ç‹è€…</button> -->
                    </div>

                    <!-- ç§¯åˆ†æ’è¡Œæ¦œ -->
                    <div id="leaderboardScore" class="leaderboard-content active">
                        <div class="leaderboard-header">
                            <span>æ’å</span>
                            <span>ç©å®¶</span>
                            <span>ç§¯åˆ†</span>
                            <span>èƒœ/è´Ÿ</span>
                        </div>
                        <div id="scoreRankingList" class="ranking-list">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <!-- èƒœç‡æ’è¡Œæ¦œ -->
                    <div id="leaderboardWinRate" class="leaderboard-content">
                        <div class="leaderboard-header">
                            <span>æ’å</span>
                            <span>ç©å®¶</span>
                            <span>èƒœç‡</span>
                            <span>æ€»åœºæ¬¡</span>
                        </div>
                        <div id="winRateRankingList" class="ranking-list">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <!-- è¿èƒœæ’è¡Œæ¦œ -->
                    <div id="leaderboardStreak" class="leaderboard-content">
                        <div class="leaderboard-header">
                            <span>æ’å</span>
                            <span>ç©å®¶</span>
                            <span>å½“å‰è¿èƒœ</span>
                            <span>æœ€é«˜è¿èƒœ</span>
                        </div>
                        <div id="streakRankingList" class="ranking-list">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <!-- å¥½å‹æ’è¡Œæ¦œ -->
                    <div id="leaderboardFriends" class="leaderboard-content">
                        <div class="leaderboard-header">
                            <span>æ’å</span>
                            <span>å¥½å‹</span>
                            <span>ç§¯åˆ†</span>
                            <span>åœ¨çº¿çŠ¶æ€</span>
                        </div>
                        <div id="friendsRankingList" class="ranking-list">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>

                    <!-- éš¾åº¦ç‹è€…æ¦œ -->
                    <div id="leaderboardDifficulty" class="leaderboard-content">
                        <div class="difficulty-tabs">
                            <button onclick="showDifficultyRanking('easy')" class="difficulty-subtab active">ğŸ˜Š ç®€å•ç‹è€…</button>
                            <button onclick="showDifficultyRanking('medium')" class="difficulty-subtab">ğŸ˜ ä¸­ç­‰ç‹è€…</button>
                            <button onclick="showDifficultyRanking('hard')" class="difficulty-subtab">ğŸ˜° å›°éš¾ç‹è€…</button>
                        </div>
                        <div class="leaderboard-header">
                            <span>æ’å</span>
                            <span>ç©å®¶</span>
                            <span>èƒœåœº</span>
                            <span>èƒœç‡</span>
                        </div>
                        <div id="difficultyRankingList" class="ranking-list">
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
                <span>åˆ·æ–°å€’è®¡æ—¶: <span id="refreshCountdown">5</span>ç§’</span>
            </div>

            <!-- å¥½å‹æ¨¡å— -->
            <div id="gameSection-friends" class="game-section">
                <div class="friends-container">
                    <div class="friends-column">
                        <!-- å…³é”®ï¼šç»™h3å¤–å±‚åŠ å®¹å™¨ï¼Œè®¾ç½®flexå¸ƒå±€å®ç°æ ‡é¢˜+æŒ‰é’®åŒè¡Œ -->
                        <div style="position: relative; display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <h3 style="margin: 0;">å¥½å‹åˆ—è¡¨</h3>
                            <button onclick="showAddFriendModal()" style="background:#edf2f7; color:#4a5568; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.3s; font-size:14px; display: inline-flex; align-items: center; gap: 4px;">
                                <div class="icon">â•</div>
                                <span>åŠ å¥½å‹</span>
                            </button>
                        </div>

                        <div id="friendsList" class="friends-list"></div>
                    </div>

                    <div class="friends-column">
                        <h3>å¥½å‹ç”³è¯·</h3>
                        <div id="friendRequests" class="requests-list"></div>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¨¡å— -->
            <div id="gameSection-chat" class="game-section">
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <h3>å¥½å‹åˆ—è¡¨</h3>
                        <div id="chatFriendsList" class="chat-friends-list"></div>
                    </div>

                    <div class="chat-main">
                        <div class="chat-header">
                            <h3 id="chatWithUser">é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©</h3>
                        </div>
                        <div id="chatMessages" class="chat-messages"></div>
                        <div class="chat-input-area">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled style="flex: 1; min-width: 0;">
                            <button onclick="sendChatMessage()" id="sendChatBtn" disabled style="white-space: nowrap; padding: 8px 12px; margin-left: 8px;">å‘é€</button>
                        </div>
                    </div>
                </div>
                <br><br><br><br><br><br><br><br><br><br><br><br>
            </div>
                    <!-- ä¸–ç•ŒèŠå¤©æ¨¡å— -->
        <div id="gameSection-worldChat" class="game-section">
            <div class="world-chat-container">
                <div class="world-chat-header">
                    <h2>ğŸŒ ä¸–ç•ŒèŠå¤©</h2>
                    <div class="online-info">
                        <span>åœ¨çº¿äººæ•°: <span id="worldChatOnlineCount">0</span></span>
                        <button onclick="loadWorldChatHistory()" class="btn-secondary">åˆ·æ–°</button>
                    </div>
                </div>
                
                <div class="world-chat-messages" id="worldChatMessages">
                    <!-- æ¶ˆæ¯åŠ¨æ€åŠ è½½ -->
                </div>
                
                <div class="world-chat-input-area">
                    <input type="text" id="worldChatInput" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆæœ€é•¿500å­—ç¬¦ï¼‰" maxlength="500">
                    <button id="sendWorldChatBtn">å‘é€</button>
                </div>
                
                <div class="world-chat-tips">
                    <p>ğŸ’¡ æç¤ºï¼šæ‰€æœ‰ç©å®¶éƒ½å¯ä»¥çœ‹åˆ°ä¸–ç•ŒèŠå¤©æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¿å­˜30åˆ†é’Ÿ</p>
                </div>
            </div>
            <br><br><br><br>
        </div>

            <!-- é¢˜åº“æ¨¡å— -->
            <div id="gameSection-questionBank" class="game-section">
                <h2>æˆ‘çš„é¢˜åº“</h2>

                <!-- é¢˜åº“æ ‡ç­¾é¡µ -->
                <div class="leaderboard-tabs" style="margin-bottom: 20px;">
                    <button onclick="showQuestionBankTab('error')" class="leaderboard-tab active" id="tabErrorBank">é”™é¢˜é¢˜åº“</button>
                    <button onclick="showQuestionBankTab('favorite')" class="leaderboard-tab" id="tabFavoriteBank">æ”¶è—é¢˜åº“</button>
                </div>

                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                <div class="btn-group">
                    <button onclick="exportCurrentQuestionBank()" id="exportBankBtn">å¯¼å‡ºä¸ºMarkdown</button>
                    <button onclick="printCurrentQuestionBank()" id="printBankBtn" style="background: #ed8936;">æ‰“å°é¢˜ç›®ï¼ˆç”µè„‘è®¿é—®ï¼‰</button>
                    <button onclick="clearCurrentQuestionBank()" id="clearBankBtn" style="background: #e53e3e; display: none;">æ¸…ç©º</button>
                    <button onclick="showGameSection('match')" style="background: #a0aec0;">è¿”å›å¯¹æˆ˜</button>
                </div>

                <!-- é¢˜åº“ç»Ÿè®¡ä¿¡æ¯ -->
                <div id="questionBankStats" style="background: #f0f8fb; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #4299e1;" id="totalQuestions">0</div>
                            <div style="font-size: 14px; color: #718096;">é¢˜ç›®æ€»æ•°</div>
                        </div>
                        <!-- <div>
                            <div style="font-size: 24px; font-weight: bold; color: #48bb78;" id="correctRate">0%</div>
                            <div style="font-size: 14px; color: #718096;">æ­£ç¡®ç‡</div>
                        </div> -->
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #ed8936;" id="lastUpdate">æš‚æ— </div>
                            <div style="font-size: 14px; color: #718096;">æœ€åæ›´æ–°</div>
                        </div>
                    </div>
                </div>

                <!-- é”™é¢˜é¢˜åº“å†…å®¹ -->
                <div id="questionBankError" class="question-bank-content active">
                    <div id="errorList"></div>
                </div>

                <!-- æ”¶è—é¢˜åº“å†…å®¹ -->
                <div id="questionBankFavorite" class="question-bank-content">
                    <div id="favoriteList"></div>
                </div>
            </div>
        </div>
        <!-- ä¸ªäººä¿¡æ¯æ¨¡å— -->
        <div id="gameSection-profile" class="game-section">
            <div class="section-header">
                <h2>ä¸ªäººä¿¡æ¯</h2>
            </div>

            <div class="profile-container">
                <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="profile-card">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="profile-info">
                        <div class="info-item">
                            <label>ç”¨æˆ·å:</label>
                            <span id="profileUsername">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="info-item">
                            <label>é‚®ç®±:</label>
                            <span id="profileEmail">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="info-item">
                            <label>ç§¯åˆ†:</label>
                            <span id="profileScore">0</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <!-- <button onclick="showEditProfileModal()" class="btn-primary">ç¼–è¾‘èµ„æ–™</button> -->
                        <button onclick="showChangePasswordModal()" class="btn-secondary">ä¿®æ”¹å¯†ç </button>
                    </div>
                </div>
                <div class="profile-card">
                    <h3>ä¿¡èª‰åˆ†è¯¦æƒ…</h3>
                    <div id="creditInfo">
                        <!-- åŠ¨æ€åŠ è½½ä¿¡èª‰åˆ†ä¿¡æ¯ -->
                    </div>
                    <div class="profile-actions">
                        <button onclick="showCreditHistory()" class="btn-secondary">æŸ¥çœ‹ä¿¡èª‰è®°å½•</button>
                    </div>
                </div>
                <!-- æˆ˜ç»©ç»Ÿè®¡å¡ç‰‡ -->
                <div class="profile-card">
                    <h3>æˆ˜ç»©ç»Ÿè®¡</h3>
                    <div class="profile-card">
                        <h3>æˆ˜ç»©ç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="profileWins">0</div>
                                <div class="stat-label">èƒœåœº</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profileLosses">0</div>
                                <div class="stat-label">è´¥åœº</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profileTotalBattles">0</div>
                                <div class="stat-label">æ€»åœºæ¬¡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profileWinRate">0%</div>
                                <div class="stat-label">èƒœç‡</div>
                            </div>
                            <!-- æ–°å¢è¿èƒœç»Ÿè®¡ -->
                            <div class="stat-item">
                                <div class="stat-value" id="profileCurrentStreak">0</div>
                                <div class="stat-label">å½“å‰è¿èƒœ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profileMaxStreak">0</div>
                                <div class="stat-label">æœ€é«˜è¿èƒœ</div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-card">
                        <h3>è¿èƒœæˆå°±</h3>
                        <div id="streakAchievements" class="achievements-container">
                            <!-- åŠ¨æ€ç”Ÿæˆè¿èƒœæˆå°± -->
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘å¯¹æˆ˜è®°å½• -->
                <div class="profile-card">
                    <h3>æœ€è¿‘å¯¹æˆ˜è®°å½•</h3>
                    <div id="battleHistoryList" class="battle-history">
                        <p style="text-align: center; color: #718096; padding: 20px;">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
        <div id="editProfileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘ä¸ªäººä¿¡æ¯</h3>
                    <span class="close" onclick="closeEditProfileModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editUsername">ç”¨æˆ·å:</label>
                        <input type="text" id="editUsername" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">é‚®ç®±:</label>
                        <input type="email" id="editEmail" placeholder="è¯·è¾“å…¥æ–°é‚®ç®±">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeEditProfileModal()" class="btn-secondary">å–æ¶ˆ</button>
                    <button onclick="updateProfile()" class="btn-primary">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
        <div id="changePasswordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ä¿®æ”¹å¯†ç </h3>
                    <span class="close" onclick="closeChangePasswordModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="currentPassword">å½“å‰å¯†ç :</label>
                        <input type="password" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">æ–°å¯†ç :</label>
                        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç :</label>
                        <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeChangePasswordModal()" class="btn-secondary">å–æ¶ˆ</button>
                    <button onclick="changePassword()" class="btn-primary">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>


        <!-- æ·»åŠ å¥½å‹æ¨¡æ€æ¡† -->
        <div id="addFriendModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">æ·»åŠ å¥½å‹</h3>
                <div class="add-friend-form">
                    <input type="text" id="friendUsername" placeholder="è¾“å…¥å¯¹æ–¹ç”¨æˆ·å" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <textarea id="friendRequestMessage" placeholder="ç”³è¯·ç•™è¨€ï¼ˆå¯é€‰ï¼‰" rows="3" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 6px;"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="sendFriendRequest()" style="flex: 1; background: #4299e1;">å‘é€ç”³è¯·</button>
                        <button onclick="closeAddFriendModal()" style="flex: 1; background: #a0aec0;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ä¿¡èª‰å†å²æ¨¡æ€æ¡† -->
<div id="creditHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>ä¿¡èª‰åˆ†å†å²è®°å½•</h3>
            <span class="close" onclick="closeCreditHistoryModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px;">
                <strong>å½“å‰ä¿¡èª‰åˆ†ï¼š</strong><span id="currentCreditValue" style="font-size: 18px; font-weight: bold; color: #4299e1;">0</span>
            </div>
            <div id="creditHistoryList" class="credit-history-list">
                <!-- åŠ¨æ€åŠ è½½ä¿¡èª‰å†å² -->
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeCreditHistoryModal()" class="btn-primary">å…³é—­</button>
        </div>
    </div>
</div>
        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div class="navbar" style="display: flex;" id="bottomNav">
            <button onclick="showGameSection('match')" class="nav-btn active" id="navMatch">
                <div class="icon">âš”ï¸</div>
                <span>å¯¹æˆ˜</span>
            </button>
            <button onclick="showGameSection('leaderboard')" class="nav-btn" id="navLeaderboard">
                <div class="icon">ğŸ†</div>
                <span>æ’è¡Œæ¦œ</span>
            </button>
            <button onclick="showGameSection('friends')" class="nav-btn" id="navFriends">
                <div class="icon">ğŸ‘¥</div>
                <span>å¥½å‹</span>
            </button>
            <button onclick="showGameSection('chat')" class="nav-btn" id="navChat">
                <div class="icon">ğŸ’¬</div>
                <span>èŠå¤©</span>
            </button>
            <button onclick="showGameSection('worldChat')" class="nav-btn" id="navWorldChat">
                <div class="icon">ğŸŒ</div>
                <span>ä¸–ç•ŒèŠå¤©</span>
            </button>
            <button onclick="showGameSection('questionBank')" class="nav-btn" id="navQuestionBank">
                <div class="icon">ğŸ“š</div>
                <span>é¢˜åº“</span>
            </button>
            <button onclick="showGameSection('profile')" class="nav-btn" id="navProfile">
                <div class="icon">ğŸ‘¤</div>
                <span>ä¸ªäººä¿¡æ¯</span>
            </button>
            <!-- <button onclick="logout()" class="nav-btn" style="color: #e53e3e;">
                <div class="icon">ğŸšª</div>
                <span>é€€å‡º</span>
            </button> -->
        </div>
    </div>

    <script>
        // å…¬å‘Šæ•°æ®
// å…¬å‘Šæ•°æ®
const announcements = [
    {
        title: "Brightly PK å¯¹æˆ˜å…¬å‘Š",
        content: `
            <h2>é‡è¦æ³¨æ„äº‹é¡¹</h2>
            
            <h3>å¯¹æˆ˜æœŸé—´</h3>
            <ul>
                <li><strong>è¯·å‹¿åˆ·æ–°é¡µé¢æˆ–é€€å‡ºç™»å½•</strong>ï¼Œå¦åˆ™ç³»ç»Ÿå°†åˆ¤å®šä¸ºä¸»åŠ¨é€€å‡ºæ¯”èµ›</li>
                <li>ä¸ºä¿è¯æ¯”èµ›å…¬å¹³æ€§ï¼Œ<strong>ä¸¥ç¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨å·¥å…·</strong>è·å–èƒœåˆ©</li>
            </ul>
            
            <h3>è´¦å·å®‰å…¨</h3>
            <ul>
                <li>å»ºè®®ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç ï¼Œç¡®ä¿ç§¯åˆ†å®‰å…¨</li>
            </ul>
            
            <h3>æ¯”èµ›è§„åˆ™</h3>
            <ul>
                <li>ç³»ç»Ÿè®¾æœ‰æ¶ˆææ¯”èµ›åˆ¤å®šæœºåˆ¶ï¼ˆè§„åˆ™è¾ƒä¸ºå®½æ¾ï¼‰</li>
                <li>è¯·å„ä½åŒå­¦è®¤çœŸå‚ä¸PKï¼Œç»´æŠ¤ä¸ªäººä¿¡èª‰ç§¯åˆ†</li>
                <li>æˆ‘ä»¬è‡´åŠ›äºæ‰“é€ å…¬å¹³ã€ä¸¥è‚ƒçš„ç«èµ›ç¯å¢ƒ</li>
            </ul>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
        `
    },
    {
        title: "å¡«ç©ºé¢˜è§„èŒƒ",
        content: `
            <h3>åŒºé—´å¡«å†™è¦æ±‚</h3>
            <ul>
                <li>å¦‚éœ€å¡«å†™å–å€¼èŒƒå›´å¯¹åº”çš„åŒºé—´</li>
                <li><strong>å¿…é¡»ä½¿ç”¨è‹±æ–‡æ‹¬å·</strong>ï¼š<code>()</code> å’Œ <code>[]</code></li>
                <li><strong>æ‰€æœ‰éæ•´æ•°å€¼å¿…é¡»ç”¨åˆ†æ•°è¡¨ç¤º</strong>ï¼Œæ ¼å¼ä¸ºï¼š<code>a/b</code>ï¼ˆaä¸ºåˆ†å­ï¼Œbä¸ºåˆ†æ¯ï¼‰</li>
            </ul>
            
            <h3>ç­”æ¡ˆè¯´æ˜</h3>
            <ul>
                <li>é¢˜ç›®ä¸­<strong>ä¸ä¼šå‡ºç°æ ¹å·ã€Ï€ã€eç­‰æ— ç†æ•°</strong></li>
                <li>å¦‚ç­”æ¡ˆä¸æ˜“è¾“å…¥ï¼Œå°†ä¸ä¼šè®¾ç½®ä¸ºå¡«ç©ºé¢˜ç­”æ¡ˆ</li>
                <li>è¯·ä»”ç»†æ£€æŸ¥ç­”æ¡ˆæ ¼å¼</li>
            </ul>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
        `
    },
    {
        title: "æ¶ˆææ¯”èµ› vs é€€å‡ºæ¯”èµ›ç§¯åˆ†å˜åŠ¨å¯¹æ¯”è¡¨",
        content: `
            <div class="highlight">
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #f7fafc;">
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">é¡¹ç›®</th>
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">æ¶ˆææ¯”èµ›</th>
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">é€€å‡º/é€ƒè·‘æ¯”èµ›</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>åˆ¤å®šè§„åˆ™</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">
                                1. æ­£ç¡®é¢˜æ•° &lt; 1é“<br>
                                2. æ¯”èµ›æ—¶é•¿ &lt; åˆç†æœ€å¿«å®Œæˆæ—¶é—´<br>
                                3. ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³
                            </td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">
                                1. æœªå®Œæˆå…¨éƒ¨é¢˜ç›®å°±æ–­å¼€è¿æ¥<br>
                                2. æœªä½¿ç”¨"å®‰å…¨é€€å‡º"åŠŸèƒ½<br>
                                3. å¯¹æˆ˜ä»åœ¨è¿›è¡Œä¸­
                            </td>
                        </tr>
                        <tr style="background-color: #f7fafc;">
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>åˆç†æœ€å¿«å®Œæˆæ—¶é—´</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">
                                ç®€å•ï¼š30ç§’<br>
                                ä¸­ç­‰ï¼š60ç§’<br>
                                å›°éš¾ï¼š120ç§’
                            </td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ä¸é€‚ç”¨</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>ç§¯åˆ†å˜åŠ¨</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">æŒ‰å®é™…ç­”é¢˜å¾—åˆ†è®¡ç®—</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">
                                èƒœè€…ï¼šè·å¾—å…¨é¢ç§¯åˆ†å¥–åŠ±<br>
                                è´¥è€…ï¼šæ‰£é™¤ä¸€åŠç§¯åˆ†
                            </td>
                        </tr>
                        <tr style="background-color: #f7fafc;">
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>ä¿¡èª‰åˆ†å˜åŠ¨</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">-2åˆ†</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">-3åˆ†</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>é¢å¤–æƒ©ç½š</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">æ¶ˆææ¯”èµ›æ¬¡æ•°+1</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">é€ƒè·‘æ¬¡æ•°+1</td>
                        </tr>
                        <tr style="background-color: #f7fafc;">
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;"><strong>å¯¹æˆ˜ç»“æœ</strong></td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">æ­£å¸¸ç»“ç®—ï¼ŒæŒ‰å¾—åˆ†åˆ¤å®šèƒœè´Ÿ</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ç«‹å³ç»“æŸï¼Œé€ƒè·‘è€…åˆ¤è´Ÿ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
        `
    },
    {
        title: "ç§¯åˆ†è§„åˆ™",
        content: `
            <h3>èƒœåˆ©åŠ åˆ†</h3>
            <div class="highlight">
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #f7fafc;">
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">éš¾åº¦çº§åˆ«</th>
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">åŠ åˆ†å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ç®€å•</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">10åˆ†/å±€</td>
                        </tr>
                        <tr style="background-color: #f7fafc;">
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ä¸­æ¡£</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">20åˆ†/å±€</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">å›°éš¾</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">50åˆ†/å±€</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h3>å¤±è´¥æ‰£åˆ†</h3>
            <div class="highlight">
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #f7fafc;">
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">éš¾åº¦çº§åˆ«</th>
                            <th style="padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0;">æ‰£åˆ†å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ç®€å•</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">5åˆ†</td>
                        </tr>
                        <tr style="background-color: #f7fafc;">
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">ä¸­æ¡£</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">10åˆ†</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">å›°éš¾</td>
                            <td style="padding: 8px 12px; border: 1px solid #e2e8f0;">25åˆ†</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background-color: #f0fff4; border-radius: 6px; border-left: 4px solid #48bb78;">
                <p style="margin: 0; font-weight: bold; color: #2d3748;">ç¥å„ä½åŒå­¦æ¯”èµ›é¡ºåˆ©ï¼Œå–å¾—å¥½æˆç»©ï¼</p>
            </div>
        `
    }
];        // æ˜¾ç¤ºå…¬å‘Šæ¨¡æ€æ¡†
        function showAnnouncementModal() {
            const modal = document.getElementById('announcementModal');
            const content = document.getElementById('announcementContent');
            
            // æ„å»ºå…¬å‘Šå†…å®¹
            let html = '';
            announcements.forEach((announcement, index) => {
                html += `
                    <div class="announcement-item">
                        <h4>${announcement.title}</h4>
                        <div>${announcement.content}</div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            modal.style.display = 'flex';
            
            // é‡ç½®"ä¸å†æ˜¾ç¤º"å¤é€‰æ¡†
            document.getElementById('dontShowAgain').checked = false;
        }

        // å…³é—­å…¬å‘Šæ¨¡æ€æ¡†
        function closeAnnouncementModal() {
            const modal = document.getElementById('announcementModal');
            const dontShowAgain = document.getElementById('dontShowAgain').checked;
            
            if (dontShowAgain) {
                // ç”¨æˆ·é€‰æ‹©ä¸å†æ˜¾ç¤ºï¼Œä¿å­˜åˆ°localStorage
                localStorage.setItem('hideAnnouncements', 'true');
                showToast('å·²è®¾ç½®ä¸å†æ˜¾ç¤ºå…¬å‘Š', 'success');
            }
            
            modal.style.display = 'none';
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå…¬å‘Š
        function checkAndShowAnnouncements() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©ä¸å†æ˜¾ç¤º
            const hideAnnouncements = localStorage.getItem('hideAnnouncements');
            
            if (!hideAnnouncements || hideAnnouncements !== 'true') {
                // å»¶è¿Ÿæ˜¾ç¤ºï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    showAnnouncementModal();
                }, 1000);
            }
        }

        // é‡ç½®"ä¸å†æ˜¾ç¤º"è®¾ç½®
        function resetAnnouncementSettings() {
            localStorage.removeItem('hideAnnouncements');
            showToast('å…¬å‘Šè®¾ç½®å·²é‡ç½®ï¼Œä¸‹æ¬¡ç™»å½•å°†æ˜¾ç¤ºå…¬å‘Š', 'success');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // æ˜¾ç¤ºæç¤º
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toastContainer.contains(toast)) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        //æƒ©ç½šé€šçŸ¥

        // åœ¨å…¨å±€å˜é‡ä¸­å®šä¹‰æœªè¯»é€šçŸ¥å­˜å‚¨é”®å
        const UNREAD_ESCAPE_NOTIFICATIONS = 'unreadEscapeNotifications';
        let unreadEscapeNotifications = []; // å­˜å‚¨æœªè¯»çš„é€ƒè·‘æƒ©ç½šé€šçŸ¥

        // ä¿å­˜æœªè¯»æƒ©ç½šé€šçŸ¥åˆ°localStorage
        function saveUnreadEscapeNotification(notification) {
            const existing = JSON.parse(localStorage.getItem(UNREAD_ESCAPE_NOTIFICATIONS) || '[]');
            existing.push(notification);
            localStorage.setItem(UNREAD_ESCAPE_NOTIFICATIONS, JSON.stringify(existing));
        }

        // è·å–å¹¶æ¸…ç©ºæœªè¯»æƒ©ç½šé€šçŸ¥
        function getAndClearUnreadEscapeNotifications() {
            const notifications = JSON.parse(localStorage.getItem(UNREAD_ESCAPE_NOTIFICATIONS) || '[]');
            localStorage.removeItem(UNREAD_ESCAPE_NOTIFICATIONS); // è¯»å–åæ¸…ç©ºï¼Œé¿å…é‡å¤æç¤º
            return notifications;
        }

// æ˜¾ç¤ºé€ƒè·‘æƒ©ç½šé€šçŸ¥
function showEscapePenaltyNotification(data) {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.classList.add('msg', 'error'); // æ·»åŠ é”™è¯¯æ¶ˆæ¯æ ·å¼
    notification.innerHTML = `
        <strong>æƒ©ç½šé€šçŸ¥</strong>ï¼šä½ åœ¨å¯¹æˆ˜ä¸­é€ƒè·‘ï¼Œä¿¡èª‰åˆ†æ‰£é™¤ ${data.penalty} åˆ†ï¼
        å½“å‰ä¿¡èª‰åˆ†ï¼š${data.currentCredit}
        <button onclick="removeEscapeNotification(this)" style="margin-left: 10px; padding: 2px 8px;">
            æŸ¥çœ‹è¯¦æƒ…
        </button>
    `;
    // æ’å…¥åˆ°é¡µé¢ï¼ˆä¾‹å¦‚æ¸¸æˆæ¨¡å—é¡¶éƒ¨ï¼‰
    const gameModule = document.getElementById('gameModule');
    gameModule.insertBefore(notification, gameModule.firstChild);
}

// ç§»é™¤é€ƒè·‘é€šçŸ¥å¹¶è·³è½¬åˆ°profile
function removeEscapeNotification(button) {
    // è·³è½¬åˆ°profileç•Œé¢
    showGameSection('profile');
    
    // ç§»é™¤é€šçŸ¥å…ƒç´ 
    const notification = button.closest('.msg.error');
    if (notification) {
        notification.remove();
    }
}



// æ˜¾ç¤ºå¯¹æˆ˜ä¿å­˜é€šçŸ¥
// æ˜¾ç¤ºå¯¹æˆ˜ä¿å­˜é€šçŸ¥
function showBattleSavedNotification(data) {
    const notification = document.createElement('div');
    notification.className = 'msg info';
    notification.style.margin = '10px 0';
    notification.style.padding = '10px';
    notification.style.borderRadius = '6px';
    notification.style.backgroundColor = '#f0f8ff';
    notification.style.border = '1px solid #4299e1';
    
    notification.innerHTML = `
        <strong>å¯¹å±€å·²ä¿å­˜</strong>
        <p style="margin: 5px 0;">${data.message || 'ä½ çš„ç­”é¢˜æ•°æ®å·²å®‰å…¨ä¿å­˜'}</p>
        <button onclick="this.closest('.msg.info').remove(); viewBattleInProfile('${data.battleId}')" 
                style="background: #4299e1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
            æŸ¥çœ‹å¯¹å±€è®°å½•
        </button>
    `;

    // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
    const gameModule = document.getElementById('gameModule');
    if (gameModule) {
        gameModule.insertBefore(notification, gameModule.firstChild);
    }
}
// æŸ¥çœ‹å¯¹å±€è®°å½•
function viewBattleInProfile(battleId) {
    showGameSection('profile');
    showToast('å·²è·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µé¢ï¼Œè¯·æŸ¥çœ‹å¯¹æˆ˜è®°å½•', 'success');
}
    </script>

    <script>
        // åŸºç¡€é…ç½®

        let currentUser = null;
        let ws = null;
        let battleId = null;
        let currentQuestionIndex = 0;
        let questions = [];
        let matchTimer = null;
        let answerTimer = null;
        let reconnectCount = 0;
        const maxReconnectCount = 5;
        let selectedDifficulty = null;
        let currentBattleId = null;
        let currentChatFriend = null;
        let opponentUserId = null;


        // æ’è¡Œæ¦œç›¸å…³å˜é‡
        let leaderboardRefreshTimer = null;
        let currentLeaderboardTab = 'score';
        let currentDifficultyTab = 'easy';

        // é¢˜åº“ç›¸å…³å˜é‡
        let currentQuestionBankTab = 'error';

        const DIFFICULTY_TIME_CONFIG = { //mintime ç³»ç»Ÿè®¤å®šçš„ "åˆç†æœ€å¿«å®Œæˆæ—¶é—´" å¿«äºè¿™ä¸ªæ—¶é—´ä»ç®—æ­£å¸¸å®Œæˆï¼Œä¸å½±å“æ»¡åˆ†è·å–
            easy: {
                maxTime: 300,
                minTime: 30,
                baseScore: 80
            },
            medium: {
                maxTime: 600,
                minTime: 60,
                baseScore: 100
            },
            hard: {
                maxTime: 900,
                minTime: 120,
                baseScore: 150
            }
        };



        //----------------é‡è¦å‡½æ•°
        // æ¨¡å—åˆ‡æ¢å‡½æ•°
        function showModule(moduleId) {
            if (moduleId === 'loginModule' || moduleId === 'registerModule') {
                document.getElementById('bottomNav').style.display = 'none';
            } else {
                document.getElementById('bottomNav').style.display = 'flex';
            }
            console.log('åˆ‡æ¢åˆ°æ¨¡å—:', moduleId);

            // éšè—æ‰€æœ‰æ¨¡å—
            document.querySelectorAll('.module').forEach(module => {
                module.style.display = 'none';
            });

            // æ˜¾ç¤ºç›®æ ‡æ¨¡å—
            const targetModule = document.getElementById(moduleId);
            if (targetModule) {
                targetModule.style.display = 'block';
            }

            // é‡ç½®æç¤ºä¿¡æ¯
            document.querySelectorAll('.msg').forEach(msg => {
                msg.textContent = '';
                msg.className = 'msg';
            });
        }

        // æ˜¾ç¤ºæ¸¸æˆéƒ¨åˆ†html
        function showGameSection(section) {
            console.log('åˆ‡æ¢åˆ°éƒ¨åˆ†:', section);
                // å¦‚æœåˆ‡æ¢åˆ°éå¯¹æˆ˜é¡µé¢ï¼Œé‡ç½®å¯¹æˆ˜çŠ¶æ€
            if (section !== 'match') {
                resetBattleState();
            }
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.game-section').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„activeç±»
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            const targetSection = document.getElementById(`gameSection-${section}`);
            const targetNav = document.getElementById(`nav${section.charAt(0).toUpperCase() + section.slice(1)}`);

            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
            }

            if (targetNav) {
                targetNav.classList.add('active');
            }

            // åŠ è½½å¯¹åº”éƒ¨åˆ†çš„æ•°æ®
            switch (section) {
                case 'friends':
                    loadFriends();
                    loadFriendRequests();
                    break;
                case 'chat':
                    loadChatFriends();
                    break;
                case 'questionBank':
                    showQuestionBankTab('error'); // é»˜è®¤æ˜¾ç¤ºé”™é¢˜é¢˜åº“
                    break;
                case 'profile':
                    loadProfileData();
                    break;
                case 'leaderboard':
                    initLeaderboard();
                    break;
                case 'worldChat':
                    initWorldChat();
                    break;
            }

            console.log('åˆ‡æ¢å®Œæˆï¼Œå½“å‰æ´»è·ƒéƒ¨åˆ†:', section);
        }

        // è¿”å›åŒ¹é…ç•Œé¢ï¼ˆåœ¨å¯¹å±€ç»“æŸåä½¿ç”¨ï¼‰
        function backToMatch() {
            resetBattleState(); // é‡ç½®å¯¹æˆ˜çŠ¶æ€ & å¯¼èˆªæ æ˜¾ç¤º
            showGameSection('match');
        }

        // æ˜¾ç¤ºä¸ªäººä¿¡æ¯æ¨¡å—
        function showProfile() {
            showGameSection('profile');
            loadProfileData();
        }


        // æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
        function showEditProfileModal() {
            // å¡«å……å½“å‰ä¿¡æ¯
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editEmail').value = currentUser.email || '';
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // ç»´æŒå¿ƒè·³è¿æ¥
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'heartbeat'
                }));
            }
        }, 30000);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('æ‰¾åˆ°å·²ç™»å½•ç”¨æˆ·:', currentUser.username);
                    await updateUserInfo();
                    showModule('gameModule');
                    initWebSocket();
                    
                    // æ£€æŸ¥å¹¶æ˜¾ç¤ºå…¬å‘Š
                    setTimeout(() => {
                        checkAndShowAnnouncements();
                    }, 500);
                } catch (e) {
                    console.error('æ¢å¤ç™»å½•çŠ¶æ€å¤±è´¥:', e);
                    localStorage.removeItem('currentUser');
                    showModule('loginModule');
                }
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°ç™»å½•ç”¨æˆ·ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
                showModule('loginModule');
            }
            console.log('åˆå§‹åŒ–å®Œæˆ');
        };
        window.addEventListener('load', function() {
            // æ·»åŠ çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
            setTimeout(function() {
                const loadingIndicator = document.getElementById('loading-indicator');
                const body = document.body;

                // æ·»åŠ åŠ è½½å®Œæˆç±»
                body.classList.remove('loading');
                body.classList.add('loaded');

                // æ·¡å‡ºåŠ è½½æç¤º
                loadingIndicator.style.opacity = '0';

                // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»å®Œæˆåå®Œå…¨ç§»é™¤
                setTimeout(function() {
                    loadingIndicator.style.display = 'none';
                }, 500);
            }, 500);

            const finalLoadTime = pageTimer.stopTimer();
            console.log('é¡µé¢å®Œå…¨åŠ è½½è€—æ—¶ï¼š' + finalLoadTime + 'ç§’');
        });
    </script>
<script src="tex-svg.js"></script>
    
</body>

</html>